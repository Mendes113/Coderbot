# ==============================================
# CODERBOT V2 - MAKEFILE
# ==============================================

.PHONY: help setup start stop restart build logs status cleanup dev prod

# VariÃ¡veis
COMPOSE_FILE = docker-compose.yml
PROJECT_NAME = coderbot-v2

# Detectar se Ã© Linux ou macOS para Docker Compose
DOCKER_COMPOSE := $(shell command -v docker-compose 2> /dev/null)
ifndef DOCKER_COMPOSE
	DOCKER_COMPOSE := docker compose
endif

# Cores para output (compatÃ­vel com make)
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
RED = \033[0;31m
NC = \033[0m

# Default target
help: ## ğŸ“‹ Mostra esta ajuda
	@echo "ğŸ¤– $(GREEN)CoderBot V2$(NC) - Sistema de Gerenciamento Docker"
	@echo ""
	@echo "$(BLUE)Comandos disponÃ­veis:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-12s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BLUE)Exemplos:$(NC)"
	@echo "  make setup    # Primeira configuraÃ§Ã£o"
	@echo "  make start    # Iniciar sistema"
	@echo "  make logs     # Ver todos os logs"
	@echo "  make dev      # Modo desenvolvimento"

setup: ## ğŸš€ ConfiguraÃ§Ã£o inicial completa
	@echo "$(GREEN)ğŸš€ Configurando CoderBot V2...$(NC)"
	@./docker-setup.sh setup

start: ## â–¶ï¸  Iniciar todos os serviÃ§os
	@echo "$(GREEN)â–¶ï¸  Iniciando CoderBot V2...$(NC)"
	@$(DOCKER_COMPOSE) up -d
	@$(MAKE) status

stop: ## â¹ï¸  Parar todos os serviÃ§os
	@echo "$(YELLOW)â¹ï¸  Parando CoderBot V2...$(NC)"
	@$(DOCKER_COMPOSE) down

restart: ## ğŸ”„ Reiniciar todos os serviÃ§os
	@echo "$(BLUE)ğŸ”„ Reiniciando CoderBot V2...$(NC)"
	@$(DOCKER_COMPOSE) restart
	@$(MAKE) status

build: ## ğŸ”¨ Reconstruir todas as imagens
	@echo "$(BLUE)ğŸ”¨ Reconstruindo imagens...$(NC)"
	@$(DOCKER_COMPOSE) build --no-cache

logs: ## ğŸ“œ Ver logs de todos os serviÃ§os
	@$(DOCKER_COMPOSE) logs -f

logs-backend: ## ğŸ“œ Ver logs apenas do backend
	@$(DOCKER_COMPOSE) logs -f backend

logs-frontend: ## ğŸ“œ Ver logs apenas do frontend
	@$(DOCKER_COMPOSE) logs -f frontend

logs-pocketbase: ## ğŸ“œ Ver logs apenas do PocketBase
	@$(DOCKER_COMPOSE) logs -f pocketbase

status: ## ğŸ“Š Status dos serviÃ§os e recursos
	@echo "$(BLUE)ğŸ“Š Status dos serviÃ§os:$(NC)"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "$(BLUE)ğŸ”— URLs disponÃ­veis:$(NC)"
	@echo "  ğŸ“± Frontend:    http://localhost:3000"
	@echo "  ğŸ”§ Backend:     http://localhost:8000"
	@echo "  ğŸ—„ï¸  PocketBase:  http://localhost:8090"
	@echo "  ğŸ’» Code Server: http://localhost:8080"

dev: ## ğŸ› ï¸  Modo desenvolvimento (com hot reload)
	@echo "$(GREEN)ğŸ› ï¸  Iniciando em modo desenvolvimento...$(NC)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ… Modo desenvolvimento ativo!$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Dicas para desenvolvimento:$(NC)"
	@echo "  â€¢ Frontend hot reload: Edite arquivos em ./frontend/"
	@echo "  â€¢ Backend hot reload: Edite arquivos em ./backend/"
	@echo "  â€¢ Ver logs: make logs"
	@echo "  â€¢ Reiniciar serviÃ§o: make restart-[serviÃ§o]"

prod: ## ğŸš€ Modo produÃ§Ã£o
	@echo "$(GREEN)ğŸš€ Preparando para produÃ§Ã£o...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) up -d --build
	@echo "$(GREEN)âœ… Sistema em produÃ§Ã£o!$(NC)"

cleanup: ## ğŸ§¹ Limpeza completa (âš ï¸  Remove volumes!)
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Isso removerÃ¡ todos os dados!$(NC)"
	@read -p "Tem certeza? (y/N): " confirm && [ "$$confirm" = "y" ]
	@echo "$(YELLOW)ğŸ§¹ Fazendo limpeza completa...$(NC)"
	@$(DOCKER_COMPOSE) down -v --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

# Comandos especÃ­ficos por serviÃ§o
restart-frontend: ## ğŸ”„ Reiniciar apenas frontend
	@$(DOCKER_COMPOSE) restart frontend

restart-backend: ## ğŸ”„ Reiniciar apenas backend
	@$(DOCKER_COMPOSE) restart backend

restart-pocketbase: ## ğŸ”„ Reiniciar apenas PocketBase
	@$(DOCKER_COMPOSE) restart pocketbase

# Comandos de shell
shell-backend: ## ğŸš Acessar shell do backend
	@$(DOCKER_COMPOSE) exec backend bash

shell-frontend: ## ğŸš Acessar shell do frontend
	@$(DOCKER_COMPOSE) exec frontend sh

shell-pocketbase: ## ğŸš Acessar shell do PocketBase
	@$(DOCKER_COMPOSE) exec pocketbase sh

# Comandos de monitoramento
health: ## ğŸ¥ Verificar saÃºde dos serviÃ§os
	@echo "$(BLUE)ğŸ¥ Verificando saÃºde dos serviÃ§os...$(NC)"
	@curl -s http://localhost:8000/health | jq '.' || echo "âŒ Backend indisponÃ­vel"
	@curl -s http://localhost:3000 > /dev/null && echo "âœ… Frontend funcionando" || echo "âŒ Frontend indisponÃ­vel"
	@curl -s http://localhost:8090/api/health > /dev/null && echo "âœ… PocketBase funcionando" || echo "âŒ PocketBase indisponÃ­vel"

stats: ## ğŸ“ˆ EstatÃ­sticas de uso dos containers
	@echo "$(BLUE)ğŸ“ˆ EstatÃ­sticas de recursos:$(NC)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

# Comandos de backup
backup: ## ğŸ’¾ Backup dos dados do PocketBase
	@echo "$(BLUE)ğŸ’¾ Fazendo backup do PocketBase...$(NC)"
	@mkdir -p ./backups
	@$(DOCKER_COMPOSE) exec pocketbase cp -r /pb/pb_data /pb/backup-$$(date +%Y%m%d_%H%M%S)
	@echo "$(GREEN)âœ… Backup criado em ./backups/$(NC)"

# Comandos de testes
test-backend: ## ğŸ§ª Testes do backend
	@echo "$(BLUE)ğŸ§ª Executando testes do backend...$(NC)"
	@$(DOCKER_COMPOSE) exec backend python -m pytest

test-frontend: ## ğŸ§ª Testes do frontend
	@echo "$(BLUE)ğŸ§ª Executando testes do frontend...$(NC)"
	@$(DOCKER_COMPOSE) exec frontend npm test

# Comandos utilitÃ¡rios
env-check: ## âœ… Verificar configuraÃ§Ã£o do ambiente
	@echo "$(BLUE)âœ… Verificando configuraÃ§Ã£o...$(NC)"
	@[ -f .env ] && echo "âœ… Arquivo .env encontrado" || echo "âŒ Arquivo .env nÃ£o encontrado"
	@docker --version > /dev/null && echo "âœ… Docker instalado" || echo "âŒ Docker nÃ£o encontrado"
	@$(DOCKER_COMPOSE) --version > /dev/null && echo "âœ… Docker Compose instalado" || echo "âŒ Docker Compose nÃ£o encontrado"

update: ## ğŸ”„ Atualizar sistema (git pull + rebuild)
	@echo "$(BLUE)ğŸ”„ Atualizando sistema...$(NC)"
	@git pull
	@$(MAKE) build
	@$(MAKE) restart
	@echo "$(GREEN)âœ… Sistema atualizado!$(NC)"

# Modo quick start para novos usuÃ¡rios
quick-start: ## ğŸš€ InÃ­cio rÃ¡pido (setup + start)
	@echo "$(GREEN)ğŸš€ InÃ­cio rÃ¡pido do CoderBot V2...$(NC)"
	@$(MAKE) env-check
	@$(MAKE) setup
	@$(MAKE) start
	@echo ""
	@echo "$(GREEN)ğŸ‰ CoderBot V2 estÃ¡ rodando!$(NC)"
	@echo "$(BLUE)ğŸ”— Acesse: http://localhost:3000$(NC)"
